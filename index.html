<!-- index.html -->
<!DOCTYPE html>
<html lang="en" id="main">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
  </head>
  <body>
    <div>
      <label>Login:</label>
      <input type="login" id="usr" placeholder="Username" onkeydown="usr_key_down()"><br><br>
      <label>Password:</label>
      <input type="password" id="pwd" placeholder="Password" onkeydown="pwd_key_down()"><br><br>
      <div><button onclick="send()">Send</button><a id="result"></a></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
    <script>
      const socket = io(document.location.href);
      var result = document.getElementById("result");
      var main = document.getElementById("main");
      var user= {};

      function send() {
        user["name"] = document.getElementById("usr").value;
        socket.emit("login", {
          "usr": user["name"],
          "pwd": document.getElementById("pwd").value,
        });
      }

      function register(){
        socket.emit("register", {
          "usr": document.getElementById("usr").value,
          "pwd": document.getElementById("pwd").value,
        });
        result.innerHTML = " wait... ";
        result.style.color = "#000000";
      }

      function next(data){

      }

      socket.on('login answer', (data) => {
        console.log(data["code"]);
        switch (data["code"]){
          case "wrong pwd":
            result.innerHTML = " * wrong password";
            result.style.color = "#FF0000";
            break;
          case "wrong usr":
            result.innerHTML = " * no such user ";
            let btn = document.createElement("button");
            btn.onclick = register;
            btn.innerHTML = "Register";
            result.appendChild(btn);
            result.style.color = "#FF0000";
            break;
          case "ok":
            result.innerHTML = " OK ";
            result.style.color = "#00FF00";
            main.innerHTML = data["new"];
            window.eval(document.getElementById("new script").innerHTML);
            break;
        }
      });
      socket.on("register answer", (data) => {
        switch (data){
          case "ok":
            result.innerHTML = " Registerd ";
            result.style.color = "#00FF00";
            break;
          case "overlap":
            result.innerHTML = " This login already taken"
            result.style.color = "#FF0000";
            break;
        }
      });
      document.getElementById("usr").focus();
      function usr_key_down(){
        if (event.keyCode == 13) {
          document.getElementById("pwd").focus();
      }}
      function pwd_key_down(){
        if (event.keyCode == 13) {
          send();
      }}
    </script>
  </body>
</html>